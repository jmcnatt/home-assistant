---
- id: '1761634337756'
  alias: Bedroom 1 Dimmer Control
  description: ''
  mode: single
  trigger:
    - platform: state
      entity_id: light.bedroom_1_dimmer
  variables:
    dimmer_on: "{{ is_state('light.bedroom_1_dimmer', 'on') }}"
    dimmer_brightness: "{{ state_attr('light.bedroom_1_dimmer', 'brightness') | int(0) }}"
    step: "{{ 255 / 6 }}"
    last_speed: "{{ states('input_number.bedroom_1_ceiling_fan_speed') | int(1) }}"

    # Handle paddle press (no brightness reported)
    brightness: >
      {% if dimmer_on and dimmer_brightness == 0 %}
        {{ (last_speed * step) | int }}
      {% elif dimmer_on %}
        {{ dimmer_brightness }}
      {% else %}
        0
      {% endif %}
    speed: >
      {% if brightness == 0 %}
        0
      {% else %}
        {% set this = (brightness / step) | round(0) | int %}
        {{ [this, 1] | max }}
      {% endif %}
  condition:
    # Only proceed if state or speed is actually different
    - condition: template
      value_template: >-
        {% set current_speed = states('input_number.bedroom_1_ceiling_fan_speed') | int(0) %}
        {% set fan_on = is_state('input_boolean.bedroom_1_ceiling_fan_power', 'on') %}
        {% if not dimmer_on and fan_on %}
          true
        {% elif dimmer_on and not fan_on %}
          true
        {% elif dimmer_on and current_speed != speed %}
          true
        {% else %}
          false
        {% endif %}
  action:
    - choose:
        - conditions: "{{ not dimmer_on }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.bedroom_1_ceiling_fan_power
        - conditions: "{{ dimmer_on }}"
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.bedroom_1_ceiling_fan_power
            - service: input_number.set_value
              target:
                entity_id: input_number.bedroom_1_ceiling_fan_speed
              data:
                value: "{{ speed }}"
