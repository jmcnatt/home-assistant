---
################################################################################
# Templates from calendars
# https://www.home-assistant.io/integrations/template/
################################################################################
- trigger:
    - platform: time
      at: 00:00:00
    - platform: homeassistant
      event: start
  action:
    - action: calendar.get_events
      target:
        entity_id: calendar.birthdays_anniversaries
      data:
        start_date_time: "{{ today_at('00:00:00') }}"
        duration:
          days: 365
      response_variable: calendar
  sensor:
    - name: calendar_birthdays_anniversaries_events
      state: "{{ now() }}"
      icon: mdi:calendar-clock
      attributes:
        dates: >-
          {% set ns = namespace(events={}) %}
          {% for event in ["Jimmy's Birthday", "Dana's Birthday", "Wedding Anniversary"] %}
            {% set date = (calendar['calendar.birthdays_anniversaries']['events']
              | selectattr('summary', 'search', event, ignorecase=true)
              | sort(attribute='start')
              | map(attribute='start')
              | map('as_datetime')
              | map('as_local')
              | first
            ).date() %}
            {% set ns.events = dict(ns.events, **{event: date|string}) %}
          {%- endfor %}
          {{ ns.events }}
