---
################################################################################
# Template - Fan - Bedroom 1 Ceiling Fan
# https://www.home-assistant.io/integrations/template/#fan
################################################################################
- fan:
  - name: "Bedroom 1 Ceiling Fan"
    speed_count: 6
    percentage: >
      {% set speed = states('input_number.bedroom_1_ceiling_fan_speed') | int %}
      {% if speed == 0 %}
        0
      {% else %}
        {{ (speed * 100 / 6) | round(0) }}
      {% endif %}
    turn_on:
        service: input_boolean.turn_on
        target:
          entity_id: input_boolean.bedroom_1_ceiling_fan_power
    turn_off:
      service: input_boolean.turn_off
      target:
        entity_id: input_boolean.bedroom_1_ceiling_fan_power
    set_percentage:
      - variables:
          step: "{{ 100 / 6 }}"
          level: >
            {% if percentage == 0 %}
              0
            {% else %}
              {% set this = (percentage / step) | round(0) | int %}
              {% if this < 1 %}1{% elif this > 6 %}6{% else %}{{ this }}{% endif %}
            {% endif %}
      - service: >
          {% if percentage == 0 %}
            input_boolean.turn_off
          {% else %}
            input_boolean.turn_on
          {% endif %}
        target:
          entity_id: input_boolean.bedroom_1_ceiling_fan_power
      - service: input_number.set_value
        target:
          entity_id: input_number.bedroom_1_ceiling_fan_speed
        data:
          value: >
            {% if percentage == 0 %}
              1
            {% else %}
              {{ ((percentage / (100 / 6)) | round(0) | int) }}
            {% endif %}
